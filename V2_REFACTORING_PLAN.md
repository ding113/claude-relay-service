# Claude Relay Service v2 é‡æ„è®¡åˆ’

**ç‰ˆæœ¬**: v2.0.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-04
**äº§å“å®šä½**: ä» Prototype åˆ° Production-Ready çš„ä¼ä¸šçº§ AI API ç½‘å…³

---

## ğŸ“‹ ç›®å½•

1. [å½“å‰åŠŸèƒ½æ¸…å•](#å½“å‰åŠŸèƒ½æ¸…å•)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
4. [åˆ†é˜¶æ®µå®æ–½è®¡åˆ’](#åˆ†é˜¶æ®µå®æ–½è®¡åˆ’)
5. [æ•°æ®è¿ç§»ç­–ç•¥](#æ•°æ®è¿ç§»ç­–ç•¥)
6. [é£é™©æ§åˆ¶](#é£é™©æ§åˆ¶)
7. [æˆåŠŸæŒ‡æ ‡](#æˆåŠŸæŒ‡æ ‡)
8. [MVPèŒƒå›´å®šä¹‰](#mvpèŒƒå›´å®šä¹‰)

---

## å½“å‰åŠŸèƒ½æ¸…å•

### æ ¸å¿ƒå¹³å°æ”¯æŒ (8ç§)

1. **Claude Official** - OAuth 2.0 PKCE è®¤è¯
2. **Claude Console** - SessionKey è®¤è¯
3. **CCR (Claude Code Relay)** - è‡ªå®šä¹‰ä¸­ç»§
4. **Gemini** - Google OAuth è®¤è¯
5. **OpenAI** - æ ‡å‡† API Key
6. **OpenAI Responses** - ç‰¹æ®Šæ ¼å¼æ”¯æŒ
7. **Azure OpenAI** - Azure è®¤è¯
8. **AWS Bedrock** - AWS IAM è®¤è¯

### 1. API Key ç®¡ç†ç³»ç»Ÿ

**æ ¸å¿ƒåŠŸèƒ½**:

- âœ… CRUD æ“ä½œï¼ˆåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼‰
- âœ… æ‰¹é‡æ“ä½œï¼ˆæ‰¹é‡åˆ›å»ºã€æ‰¹é‡ç¼–è¾‘ã€æ‰¹é‡åˆ é™¤ï¼‰
- âœ… è½¯åˆ é™¤ + æ¢å¤æœºåˆ¶ï¼ˆå›æ”¶ç«™åŠŸèƒ½ï¼‰
- âœ… è¿‡æœŸç®¡ç†ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ã€ç»­æœŸã€è‡ªåŠ¨æ¸…ç†ï¼‰
- âœ… æ ‡ç­¾ç³»ç»Ÿï¼ˆåˆ†ç±»ç®¡ç†ï¼‰
- âœ… æƒé™æ§åˆ¶ï¼ˆæœåŠ¡æƒé™ï¼šall/claude/gemini/openaiï¼‰
- âœ… æ¨¡å‹é™åˆ¶ï¼ˆé»‘åå•æ¨¡å¼ï¼‰
- âœ… å“ˆå¸Œæ˜ å°„ï¼ˆO(1) æŸ¥æ‰¾ä¼˜åŒ–ï¼‰

**é«˜çº§åŠŸèƒ½**:

- âœ… æ»‘åŠ¨çª—å£é™æµï¼ˆå°æ—¶/å¤©/å‘¨/æœˆå¤šç»´åº¦ï¼‰
- âœ… ç”¨æˆ·å…³è”ï¼ˆæ”¯æŒ LDAP é›†æˆï¼‰
- âœ… æˆæœ¬è·Ÿè¸ªï¼ˆå¤šç»´åº¦è´¹ç”¨ç»Ÿè®¡ï¼‰
- âœ… ä½¿ç”¨ç»Ÿè®¡ï¼ˆè¯·æ±‚æ•°ã€Tokenã€æˆæœ¬ï¼‰
- âœ… å®¢æˆ·ç«¯æ ‡è¯†ï¼ˆSillyTavernã€Claude Codeç­‰ï¼‰

### 2. è´¦æˆ·ç®¡ç†ç³»ç»Ÿ

**Claude OAuth è´¦æˆ·**:

- âœ… OAuth 2.0 PKCE å®Œæ•´æµç¨‹
- âœ… è‡ªåŠ¨ Token åˆ·æ–°ï¼ˆ10ç§’æå‰ç­–ç•¥ï¼‰
- âœ… ä»£ç†æ”¯æŒï¼ˆSOCKS5/HTTPï¼‰
- âœ… Opus æƒé™æ£€æµ‹
- âœ… è®¢é˜…ä¿¡æ¯ç®¡ç†ï¼ˆPro/Max/Freeï¼‰
- âœ… ä¼šè¯çª—å£ç®¡ç†ï¼ˆåŸºäºUTCæ—¶é—´ï¼‰
- âœ… é™æµçŠ¶æ€è‡ªåŠ¨æ¢å¤

**å…¶ä»–è´¦æˆ·ç±»å‹**:

- âœ… Claude Consoleï¼ˆSessionKeyç®¡ç†ï¼‰
- âœ… CCR è´¦æˆ·
- âœ… Gemini OAuth
- âœ… OpenAI API Key
- âœ… Azure OpenAI
- âœ… Bedrock (AWS IAM)

**è´¦æˆ·ç»„ç®¡ç†**:

- âœ… åˆ†ç»„åŠŸèƒ½ï¼ˆæŒ‰å¹³å°åˆ†ç»„ï¼‰
- âœ… æ‰¹é‡è´¦æˆ·ç®¡ç†
- âœ… æˆå‘˜ç®¡ç†

### 3. ç»Ÿä¸€è°ƒåº¦ç³»ç»Ÿ

**æ™ºèƒ½è´¦æˆ·é€‰æ‹©**:

- âœ… æ¨¡å‹åŒ¹é…ï¼ˆOpusæƒé™æ£€æµ‹ï¼‰
- âœ… Sticky Sessionï¼ˆä¼šè¯ç²˜æ€§ï¼‰
- âœ… é™æµæ„ŸçŸ¥ï¼ˆè‡ªåŠ¨è·³è¿‡å—é™è´¦æˆ·ï¼‰
- âœ… è´Ÿè½½å‡è¡¡
- âœ… é”™è¯¯éš”ç¦»ï¼ˆè‡ªåŠ¨æ ‡è®°æ•…éšœè´¦æˆ·ï¼‰

**è°ƒåº¦å™¨ç±»å‹**:

- âœ… Unified Claude Scheduler
- âœ… Unified Gemini Scheduler
- âœ… Unified OpenAI Scheduler

### 4. API è½¬å‘ä¸å…¼å®¹å±‚

**æ ‡å‡† API**:

- âœ… `/api/v1/messages` - Claude æ ¼å¼
- âœ… `/gemini/*` - æ ‡å‡† Gemini æ ¼å¼
- âœ… `/openai/*` - OpenAI æ ‡å‡†æ ¼å¼

**å…¼å®¹å±‚**:

- âœ… OpenAI â†’ Claude æ ¼å¼è½¬æ¢
- âœ… OpenAI â†’ Gemini æ ¼å¼è½¬æ¢
- âœ… Claude Code Headers æ”¯æŒ
- âœ… Azure OpenAI å…¼å®¹

**æµå¼æ”¯æŒ**:

- âœ… SSE (Server-Sent Events)
- âœ… çœŸå® Usage æ•°æ®æ•è·
- âœ… å®¢æˆ·ç«¯æ–­å¼€è‡ªåŠ¨æ¸…ç†
- âœ… èƒŒå‹å¤„ç† (Backpressure)

### 5. ä½¿ç”¨ç»Ÿè®¡ä¸æˆæœ¬è·Ÿè¸ª

**å¤šç»´åº¦ç»Ÿè®¡**:

- âœ… æŒ‰æ—¥æœŸï¼ˆæ—¥/å‘¨/æœˆï¼‰
- âœ… æŒ‰ API Key
- âœ… æŒ‰æ¨¡å‹
- âœ… æŒ‰ç”¨æˆ·
- âœ… æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

**æˆæœ¬è®¡ç®—**:

- âœ… åŠ¨æ€å®šä»·æœåŠ¡
- âœ… Input/Output Token åˆ†åˆ«è®¡è´¹
- âœ… å®æ—¶æˆæœ¬æ›´æ–°
- âœ… è´¹ç”¨åˆå§‹åŒ–æœåŠ¡

**æ•°æ®å­˜å‚¨**:

- âœ… Redis Hash ä¼˜åŒ–å­˜å‚¨
- âœ… æ—¶åŒºæ„ŸçŸ¥ï¼ˆUTC+8 å¯é…ç½®ï¼‰
- âœ… å®šæœŸæ¸…ç†ä»»åŠ¡

### 6. ç”¨æˆ·ç³»ç»Ÿ

**ç”¨æˆ·ç®¡ç†**:

- âœ… CRUD æ“ä½œ
- âœ… è§’è‰²æƒé™ï¼ˆadmin/userï¼‰
- âœ… çŠ¶æ€ç®¡ç†ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
- âœ… LDAP é›†æˆ
- âœ… ä¼šè¯ç®¡ç†ï¼ˆJWT Tokenï¼‰

**ç”¨æˆ·åŠŸèƒ½**:

- âœ… ç‹¬ç«‹ç™»å½•å…¥å£
- âœ… ä¸ªäººä»ªè¡¨æ¿
- âœ… API Key è‡ªåŠ©ç®¡ç†
- âœ… ä½¿ç”¨ç»Ÿè®¡æŸ¥çœ‹

### 7. Webhook é€šçŸ¥ç³»ç»Ÿ

**æ”¯æŒå¹³å° (9ç§)**:

- âœ… ä¼ä¸šå¾®ä¿¡ (WeChat Work)
- âœ… é’‰é’‰ (DingTalk)
- âœ… é£ä¹¦ (Feishu)
- âœ… Slack
- âœ… Discord
- âœ… Telegram
- âœ… Bark (iOS)
- âœ… SMTP (é‚®ä»¶)
- âœ… Custom Webhook

**é€šçŸ¥ç±»å‹**:

- âœ… ç³»ç»Ÿé”™è¯¯
- âœ… è´¦æˆ·çŠ¶æ€å˜æ›´
- âœ… é™æµå‘Šè­¦
- âœ… è´¹ç”¨å‘Šè­¦
- âœ… æµ‹è¯•é€šçŸ¥

### 8. Web ç®¡ç†ç•Œé¢ (Vue 3 SPA)

**é¡µé¢æ¸…å•**:

1. **Dashboard** - ç³»ç»Ÿæ¦‚è§ˆã€ä½¿ç”¨è¶‹åŠ¿ã€æ¨¡å‹åˆ†å¸ƒ
2. **API Keys** - Key ç®¡ç†ã€æ‰¹é‡æ“ä½œã€ä½¿ç”¨è¯¦æƒ…
3. **Accounts** - å¤šè´¦æˆ·ç®¡ç†ã€OAuth æµç¨‹ã€ä»£ç†é…ç½®
4. **API Stats** - å…¬å¼€ç»Ÿè®¡æŸ¥è¯¢ï¼ˆæ— éœ€ç™»å½•ï¼‰
5. **User Management** - ç”¨æˆ·ç®¡ç†ã€è§’è‰²åˆ†é…
6. **Settings** - Webhook é…ç½®ã€ç³»ç»Ÿè®¾ç½®
7. **Tutorial** - ä½¿ç”¨æ•™ç¨‹
8. **User Dashboard** - ç”¨æˆ·ä¸ªäººä»ªè¡¨æ¿
9. **Login** - ç®¡ç†å‘˜ç™»å½•
10. **User Login** - ç”¨æˆ·ç™»å½•

**UI ç‰¹æ€§**:

- âœ… å“åº”å¼è®¾è®¡ï¼ˆæ‰‹æœº/å¹³æ¿/æ¡Œé¢ï¼‰
- âœ… æš—é»‘æ¨¡å¼æ”¯æŒ
- âœ… Element Plus ç»„ä»¶åº“
- âœ… Chart.js å¯è§†åŒ–
- âœ… Tailwind CSS
- âœ… Pinia çŠ¶æ€ç®¡ç†

### 9. å®‰å…¨ä¸è®¤è¯

**è®¤è¯æœºåˆ¶**:

- âœ… API Key è®¤è¯ï¼ˆå“ˆå¸Œå­˜å‚¨ï¼‰
- âœ… JWT Sessionï¼ˆç®¡ç†å‘˜ï¼‰
- âœ… JWT Sessionï¼ˆç”¨æˆ·ï¼‰
- âœ… LDAP é›†æˆ

**å®‰å…¨æªæ–½**:

- âœ… AES åŠ å¯†ï¼ˆæ•æ„Ÿæ•°æ®ï¼‰
- âœ… BCrypt å¯†ç å“ˆå¸Œ
- âœ… é€Ÿç‡é™åˆ¶ï¼ˆrate-limiter-flexibleï¼‰
- âœ… Helmet å®‰å…¨å¤´
- âœ… CORS é…ç½®
- âœ… è¾“å…¥éªŒè¯

### 10. è¿ç»´ä¸ç›‘æ§

**ç›‘æ§**:

- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹ (`/health`)
- âœ… Metrics ç«¯ç‚¹ (`/metrics`)
- âœ… ç¼“å­˜ç›‘æ§ç³»ç»Ÿ
- âœ… Winston ç»“æ„åŒ–æ—¥å¿—
- âœ… æ—¥å¿—è½®è½¬ï¼ˆæŒ‰æ—¥æœŸï¼‰

**è¿ç»´å·¥å…·**:

- âœ… CLI ç®¡ç†å·¥å…·
- âœ… æœåŠ¡ç®¡ç†è„šæœ¬ï¼ˆdaemonæ¨¡å¼ï¼‰
- âœ… æ•°æ®å¯¼å…¥/å¯¼å‡º
- âœ… æ•°æ®è¿ç§»è„šæœ¬
- âœ… Dockeræ”¯æŒ
- âœ… Docker Compose (å«ç›‘æ§æ ˆ)

**å®šæœŸä»»åŠ¡**:

- âœ… è¿‡æœŸ Key æ¸…ç†
- âœ… é”™è¯¯è´¦æˆ·é‡ç½®
- âœ… é™æµçŠ¶æ€æ¸…ç†
- âœ… Token è‡ªåŠ¨åˆ·æ–°

---

## æŠ€æœ¯æ¶æ„

### åç«¯æŠ€æœ¯æ ˆ

```
Node.js 20+ + TypeScript 5+
â”œâ”€â”€ æ¡†æ¶: Fastify (æ¯”Expressæ€§èƒ½æ›´å¥½)
â”œâ”€â”€ æ•°æ®å±‚: ioredis + Drizzle ORM (ç±»å‹å®‰å…¨)
â”œâ”€â”€ è®¤è¯: Passport.js (ç»Ÿä¸€è®¤è¯ç­–ç•¥)
â”œâ”€â”€ éªŒè¯: Zod (è¿è¡Œæ—¶ç±»å‹éªŒè¯)
â”œâ”€â”€ æ—¥å¿—: Pino (Fastifyå®˜æ–¹)
â”œâ”€â”€ æµ‹è¯•: Vitest + Supertest
â”œâ”€â”€ ä»£ç è´¨é‡: ESLint + Prettier + ts-standard
â””â”€â”€ æ–‡æ¡£: OpenAPI/Swagger (è‡ªåŠ¨ç”Ÿæˆ)
```

**ä¸ºä»€ä¹ˆé€‰ Fastify è€Œä¸æ˜¯ Express?**

- åŸç”Ÿ TypeScript æ”¯æŒ
- æ€§èƒ½æå‡ 2-3xï¼ˆJSON Schema éªŒè¯ï¼‰
- æ›´å¥½çš„å¼‚æ­¥é”™è¯¯å¤„ç†
- æ’ä»¶ç³»ç»Ÿæ›´æ¸…æ™°

### å‰ç«¯æŠ€æœ¯æ ˆ

```
Next.js 15 (App Router) + TypeScript
â”œâ”€â”€ UI: Shadcn/ui + Tailwind CSS (ä¿æŒè®¾è®¡è¯­è¨€ä¸€è‡´æ€§)
â”œâ”€â”€ çŠ¶æ€ç®¡ç†: Zustand (æ¯”Piniaæ›´è½»é‡)
â”œâ”€â”€ æ•°æ®è·å–: TanStack Query (è‡ªåŠ¨ç¼“å­˜+é‡è¯•)
â”œâ”€â”€ è¡¨å•: React Hook Form + Zod
â”œâ”€â”€ å›¾è¡¨: Recharts (ReactåŸç”Ÿ)
â”œâ”€â”€ å·¥å…·: Day.js + lodash-es
â””â”€â”€ éƒ¨ç½²: Static Export (æ— éœ€SSR)
```

**ä¸ºä»€ä¹ˆé€‰ Next.js App Router?**

- Server Actions ç®€åŒ– API è°ƒç”¨
- æ–‡ä»¶è·¯ç”±æ¸…æ™°
- å†…ç½®ä¼˜åŒ–ï¼ˆå›¾ç‰‡ã€å­—ä½“ã€Bundleï¼‰
- å¯é€‰ SSRï¼ˆæœªæ¥å¯ç”¨ï¼‰

---

## é¡¹ç›®ç»“æ„

### Monorepo ç»“æ„ï¼ˆæ¨èï¼‰

```
claude-relay-service/
â”œâ”€â”€ v1/                          # ç°æœ‰ä»£ç ï¼ˆåªè¯»ï¼Œä¾›å‚è€ƒï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ web/
â”‚   â””â”€â”€ README_V1.md
â”‚
â”œâ”€â”€ packages/                    # v2 ä»£ç 
â”‚   â”œâ”€â”€ backend/                 # åç«¯ (TypeScript)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ modules/         # åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ apikey/      # API Keyæ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ account/     # è´¦æˆ·æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ relay/       # è½¬å‘æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ stats/       # ç»Ÿè®¡æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user/        # ç”¨æˆ·æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ webhook/     # Webhookæ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ core/            # æ ¸å¿ƒå±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ redis/       # Rediså®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth/        # è®¤è¯ç­–ç•¥
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ scheduler/   # ç»Ÿä¸€è°ƒåº¦å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ logger/      # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ shared/          # å…±äº«å·¥å…·
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ types/       # TypeScriptç±»å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ utils/       # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ constants/   # å¸¸é‡
â”‚   â”‚   â”‚   â””â”€â”€ server.ts        # FastifyæœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ tests/               # æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ frontend/                # å‰ç«¯ (Next.js)
â”‚   â”‚   â”œâ”€â”€ app/                 # App Router
â”‚   â”‚   â”‚   â”œâ”€â”€ (admin)/         # ç®¡ç†å‘˜è·¯ç”±ç»„
â”‚   â”‚   â”‚   â”œâ”€â”€ (user)/          # ç”¨æˆ·è·¯ç”±ç»„
â”‚   â”‚   â”‚   â”œâ”€â”€ (public)/        # å…¬å¼€è·¯ç”±ç»„
â”‚   â”‚   â”‚   â””â”€â”€ api/             # API Routes (å¯é€‰)
â”‚   â”‚   â”œâ”€â”€ components/          # ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ui/              # Shadcnç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ features/        # åŠŸèƒ½ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ layouts/         # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ lib/                 # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ stores/              # Zustand stores
â”‚   â”‚   â”œâ”€â”€ types/               # TypeScriptç±»å‹
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ next.config.js
â”‚   â”‚
â”‚   â””â”€â”€ shared/                  # å‰åç«¯å…±äº«
â”‚       â”œâ”€â”€ types/               # APIç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ constants/           # å¸¸é‡
â”‚       â””â”€â”€ validators/          # Zod schemas
â”‚
â”œâ”€â”€ scripts/                     # å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ migrate-data.ts          # æ•°æ®è¿ç§»
â”‚   â””â”€â”€ dev.sh                   # å¼€å‘è„šæœ¬
â”‚
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ Dockerfile.v2
â”‚   â””â”€â”€ docker-compose.v2.yml
â”‚
â”œâ”€â”€ package.json                 # Root package
â”œâ”€â”€ pnpm-workspace.yaml          # PNPM workspace
â””â”€â”€ turbo.json                   # Turborepoé…ç½®(å¯é€‰)
```

---

## åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### é˜¶æ®µ 0: å‡†å¤‡é˜¶æ®µ (Week 1-2)

**ç›®æ ‡**: æ­å»ºåŸºç¡€æ¶æ„ï¼ŒéªŒè¯æŠ€æœ¯é€‰å‹

**ä»»åŠ¡æ¸…å•**:

- [ ] åˆ›å»º Monorepo ç»“æ„
- [ ] é…ç½® TypeScript + ESLint + Prettier
- [ ] æ­å»º Fastify åŸºç¡€æœåŠ¡å™¨
- [ ] æ­å»º Next.js åŸºç¡€é¡¹ç›®
- [ ] é…ç½® Redis è¿æ¥ï¼ˆå¤ç”¨ v1 å®ä¾‹ï¼‰
- [ ] å®ç°å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] é…ç½® Docker å¼€å‘ç¯å¢ƒ

**éªŒæ”¶æ ‡å‡†**:

- âœ… `npm run dev` å¯åŠ¨ v2 åç«¯ (localhost:4000)
- âœ… `npm run dev:web` å¯åŠ¨ v2 å‰ç«¯ (localhost:3000)
- âœ… `/health` ç«¯ç‚¹æ­£å¸¸å“åº”
- âœ… TypeScript ç¼–è¯‘æ— é”™è¯¯

**æŠ€æœ¯é£é™©**:

- Redis è¿æ¥å…±äº«ï¼ˆä½¿ç”¨ä¸åŒ key å‰ç¼€: `v2:*`ï¼‰
- ç«¯å£å†²çªï¼ˆv1:3000, v2 åç«¯:4000, v2 å‰ç«¯:3001ï¼‰

---

### é˜¶æ®µ 1: æ ¸å¿ƒåŸºç¡€è®¾æ–½ (Week 3-4)

**ç›®æ ‡**: å®ç°è®¤è¯ã€æ•°æ®å±‚ã€æ—¥å¿—ç³»ç»Ÿ

**æ¨¡å—ä¼˜å…ˆçº§**:

1. **Redis æ•°æ®å±‚** (å¤ç”¨ v1 æ•°æ®ç»“æ„)
   - ç±»å‹å®‰å…¨çš„ Redis å®¢æˆ·ç«¯å°è£…
   - æ•°æ®æ¨¡å‹å®šä¹‰ (Zod schemas)
   - åŠ å¯†å·¥å…·ç±»ï¼ˆAESï¼‰
2. **è®¤è¯ç³»ç»Ÿ**
   - JWT ä¸­é—´ä»¶
   - API Key éªŒè¯ä¸­é—´ä»¶
   - ç”¨æˆ·è®¤è¯ä¸­é—´ä»¶
3. **æ—¥å¿—ç³»ç»Ÿ**
   - Pino logger é…ç½®
   - è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
   - é”™è¯¯è¿½è¸ª

**API ç«¯ç‚¹**:

```
POST /api/v2/auth/admin/login    - ç®¡ç†å‘˜ç™»å½•
POST /api/v2/auth/user/login     - ç”¨æˆ·ç™»å½•
POST /api/v2/auth/logout          - ç™»å‡º
GET  /api/v2/auth/me              - å½“å‰ç”¨æˆ·ä¿¡æ¯
```

**å‰ç«¯é¡µé¢**:

- ç™»å½•é¡µé¢ï¼ˆç®¡ç†å‘˜+ç”¨æˆ·ï¼‰
- å¸ƒå±€ç»„ä»¶ï¼ˆHeader + Sidebarï¼‰

**éªŒæ”¶æ ‡å‡†**:

- âœ… ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼Œè·å– JWT Token
- âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ
- âœ… å—ä¿æŠ¤è·¯ç”±æ­£å¸¸å·¥ä½œ
- âœ… æ—¥å¿—æ­£ç¡®è¾“å‡ºåˆ°æ–‡ä»¶

---

### é˜¶æ®µ 2: API Key ç®¡ç† (Week 5-6)

**ç›®æ ‡**: å®Œæ•´çš„ API Key CRUD + ä½¿ç”¨ç»Ÿè®¡

**åç«¯æ¨¡å—**:

- `modules/apikey/` - å®Œæ•´ CRUD
- `modules/stats/` - ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢

**API ç«¯ç‚¹**:

```
GET    /api/v2/keys              - åˆ—è¡¨ï¼ˆåˆ†é¡µ+è¿‡æ»¤ï¼‰
POST   /api/v2/keys              - åˆ›å»º
GET    /api/v2/keys/:id          - è¯¦æƒ…
PUT    /api/v2/keys/:id          - æ›´æ–°
DELETE /api/v2/keys/:id          - åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
POST   /api/v2/keys/batch        - æ‰¹é‡åˆ›å»º
PUT    /api/v2/keys/batch        - æ‰¹é‡æ›´æ–°
GET    /api/v2/keys/:id/stats    - ä½¿ç”¨ç»Ÿè®¡
POST   /api/v2/keys/:id/restore  - æ¢å¤
```

**å‰ç«¯é¡µé¢**:

- API Keys åˆ—è¡¨é¡µï¼ˆè¡¨æ ¼+åˆ†é¡µ+ç­›é€‰ï¼‰
- åˆ›å»º Key å¼¹çª—
- ç¼–è¾‘ Key å¼¹çª—
- æ‰¹é‡æ“ä½œç•Œé¢
- ä½¿ç”¨ç»Ÿè®¡è¯¦æƒ…

**éªŒæ”¶æ ‡å‡†**:

- âœ… å®Œæ•´ CRUD åŠŸèƒ½æ­£å¸¸
- âœ… æ‰¹é‡æ“ä½œæˆåŠŸ
- âœ… ç»Ÿè®¡æ•°æ®å‡†ç¡®
- âœ… UI é€‚é…æš—é»‘æ¨¡å¼
- âœ… å“åº”å¼è®¾è®¡æ­£å¸¸

**æ•°æ®è¿ç§»**:

- ç¼–å†™è„šæœ¬ä» v1 åŒæ­¥ API Key æ•°æ®åˆ° v2 (å¯é€‰)

---

### é˜¶æ®µ 3: è´¦æˆ·ç®¡ç† (Week 7-9)

**ç›®æ ‡**: å®ç°æ‰€æœ‰è´¦æˆ·ç±»å‹çš„ç®¡ç†

**ä¼˜å…ˆçº§é¡ºåº**:

1. Claude OAuthï¼ˆæœ€å¤æ‚ï¼Œä¼˜å…ˆå®ç°ï¼‰
2. Gemini OAuth
3. OpenAI
4. å…¶ä»–è´¦æˆ·ç±»å‹

**åç«¯æ¨¡å—**:

- `modules/account/claude/` - Claudeè´¦æˆ·
- `modules/account/gemini/` - Geminiè´¦æˆ·
- `modules/account/openai/` - OpenAIè´¦æˆ·
- `modules/account/group/` - è´¦æˆ·åˆ†ç»„

**API ç«¯ç‚¹**:

```
# Claude OAuth
POST   /api/v2/accounts/claude/auth-url     - ç”ŸæˆæˆæƒURL
POST   /api/v2/accounts/claude/exchange     - äº¤æ¢code
GET    /api/v2/accounts/claude              - åˆ—è¡¨
POST   /api/v2/accounts/claude              - åˆ›å»º
PUT    /api/v2/accounts/claude/:id          - æ›´æ–°
DELETE /api/v2/accounts/claude/:id          - åˆ é™¤
POST   /api/v2/accounts/claude/:id/refresh  - åˆ·æ–°token

# ç±»ä¼¼çš„å…¶ä»–è´¦æˆ·ç±»å‹ç«¯ç‚¹...

# è´¦æˆ·ç»„
GET    /api/v2/account-groups               - åˆ—è¡¨
POST   /api/v2/account-groups               - åˆ›å»º
PUT    /api/v2/account-groups/:id           - æ›´æ–°
DELETE /api/v2/account-groups/:id           - åˆ é™¤
```

**å‰ç«¯é¡µé¢**:

- è´¦æˆ·ç®¡ç†é¡µé¢ï¼ˆå¤šTabåˆ‡æ¢ï¼‰
- OAuth æˆæƒæµç¨‹ç»„ä»¶
- ä»£ç†é…ç½®è¡¨å•
- è´¦æˆ·åˆ†ç»„ç®¡ç†

**éªŒæ”¶æ ‡å‡†**:

- âœ… OAuth å®Œæ•´æµç¨‹æ­£å¸¸
- âœ… Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- âœ… ä»£ç†é…ç½®æ­£å¸¸å·¥ä½œ
- âœ… è´¦æˆ·çŠ¶æ€å®æ—¶æ›´æ–°

---

### é˜¶æ®µ 4: API è½¬å‘æ ¸å¿ƒ (Week 10-12)

**ç›®æ ‡**: å®ç°æ ¸å¿ƒè½¬å‘åŠŸèƒ½ + ç»Ÿä¸€è°ƒåº¦å™¨

**åç«¯æ¨¡å—**:

- `modules/relay/claude/` - Claudeè½¬å‘
- `modules/relay/gemini/` - Geminiè½¬å‘
- `modules/relay/openai/` - OpenAIè½¬å‘
- `core/scheduler/` - ç»Ÿä¸€è°ƒåº¦å™¨

**API ç«¯ç‚¹**:

```
POST /api/v1/messages              - Claudeæ ¼å¼ï¼ˆä¿æŒå…¼å®¹ï¼‰
POST /gemini/v1/messages           - Geminiæ ¼å¼
POST /openai/v1/chat/completions   - OpenAIæ ¼å¼
GET  /api/v1/models                - æ¨¡å‹åˆ—è¡¨
GET  /api/v1/usage                 - ä½¿ç”¨é‡æŸ¥è¯¢
```

**å…³é”®åŠŸèƒ½**:

- âœ… æµå¼å“åº”ï¼ˆSSEï¼‰
- âœ… Usage æ•°æ®æ•è·
- âœ… æ™ºèƒ½è´¦æˆ·é€‰æ‹©
- âœ… Sticky Session
- âœ… é™æµæ£€æµ‹
- âœ… é”™è¯¯é‡è¯•
- âœ… å®æ—¶ç»Ÿè®¡æ›´æ–°

**éªŒæ”¶æ ‡å‡†**:

- âœ… ä½¿ç”¨ v2 API æˆåŠŸè°ƒç”¨ Claude
- âœ… æµå¼å“åº”æ­£å¸¸
- âœ… Usage æ•°æ®å‡†ç¡®
- âœ… è°ƒåº¦å™¨é€‰æ‹©æ­£ç¡®è´¦æˆ·
- âœ… é™æµè‡ªåŠ¨åˆ‡æ¢è´¦æˆ·

---

### é˜¶æ®µ 5: ç”¨æˆ·ç³»ç»Ÿ + Webhook (Week 13-14)

**ç›®æ ‡**: å®Œæ•´ç”¨æˆ·ç®¡ç† + Webhook é€šçŸ¥

**åç«¯æ¨¡å—**:

- `modules/user/` - ç”¨æˆ·ç®¡ç†
- `modules/webhook/` - Webhookç³»ç»Ÿ

**API ç«¯ç‚¹**:

```
# ç”¨æˆ·ç®¡ï¿½ï¿½ï¿½
GET    /api/v2/users               - åˆ—è¡¨
POST   /api/v2/users               - åˆ›å»º
PUT    /api/v2/users/:id           - æ›´æ–°
PATCH  /api/v2/users/:id/status    - å¯ç”¨/ç¦ç”¨
GET    /api/v2/users/:id/stats     - ä½¿ç”¨ç»Ÿè®¡

# Webhook
GET    /api/v2/webhooks            - é…ç½®åˆ—è¡¨
POST   /api/v2/webhooks            - åˆ›å»ºé…ç½®
PUT    /api/v2/webhooks/:id        - æ›´æ–°
DELETE /api/v2/webhooks/:id        - åˆ é™¤
POST   /api/v2/webhooks/test       - æµ‹è¯•å‘é€
```

**å‰ç«¯é¡µé¢**:

- ç”¨æˆ·ç®¡ç†é¡µé¢
- ç”¨æˆ·ä»ªè¡¨æ¿
- Webhook é…ç½®é¡µé¢

**éªŒæ”¶æ ‡å‡†**:

- âœ… ç”¨æˆ· CRUD æ­£å¸¸
- âœ… LDAP é›†æˆï¼ˆå¯é€‰ï¼‰
- âœ… Webhook é€šçŸ¥æ­£å¸¸å‘é€

---

### é˜¶æ®µ 6: ä»ªè¡¨æ¿ + ç»Ÿè®¡ (Week 15-16)

**ç›®æ ‡**: å®Œæ•´çš„æ•°æ®å¯è§†åŒ–å’Œç»Ÿè®¡åˆ†æ

**åç«¯æ¨¡å—**:

- `modules/stats/dashboard/` - ä»ªè¡¨æ¿æ•°æ®
- `modules/stats/analytics/` - åˆ†ææŸ¥è¯¢

**API ç«¯ç‚¹**:

```
GET /api/v2/dashboard/overview     - ç³»ç»Ÿæ¦‚è§ˆ
GET /api/v2/stats/usage            - ä½¿ç”¨ç»Ÿè®¡ï¼ˆå¤šç»´åº¦ï¼‰
GET /api/v2/stats/cost             - æˆæœ¬ç»Ÿè®¡
GET /api/v2/stats/models           - æ¨¡å‹åˆ†å¸ƒ
GET /api/v2/stats/trends           - è¶‹åŠ¿åˆ†æ
```

**å‰ç«¯é¡µé¢**:

- Dashboardï¼ˆç³»ç»Ÿæ¦‚è§ˆï¼‰
- API Statsï¼ˆå…¬å¼€ç»Ÿè®¡é¡µï¼‰
- ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨
- æ¨¡å‹åˆ†å¸ƒå›¾

**éªŒæ”¶æ ‡å‡†**:

- âœ… å›¾è¡¨æ•°æ®å‡†ç¡®
- âœ… å®æ—¶æ›´æ–°ï¼ˆå¯é€‰ï¼‰
- âœ… å¯¼å‡ºåŠŸèƒ½ï¼ˆExcelï¼‰
- âœ… æ—¶é—´èŒƒå›´ç­›é€‰

---

### é˜¶æ®µ 7: æµ‹è¯• + æ–‡æ¡£ (Week 17-18)

**ç›®æ ‡**: å®Œæ•´æµ‹è¯•è¦†ç›– + æ–‡æ¡£

**æµ‹è¯•**:

- å•å…ƒæµ‹è¯•ï¼ˆVitestï¼‰- è¦†ç›–ç‡ >80%
- é›†æˆæµ‹è¯•ï¼ˆSupertestï¼‰- æ ¸å¿ƒAPI
- E2E æµ‹è¯•ï¼ˆPlaywrightï¼‰- å…³é”®æµç¨‹

**æ–‡æ¡£**:

- OpenAPI/Swagger æ–‡æ¡£ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- éƒ¨ç½²æ–‡æ¡£
- API ä½¿ç”¨æ–‡æ¡£
- è¿ç§»æŒ‡å—

**éªŒæ”¶æ ‡å‡†**:

- âœ… æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡
- âœ… æ‰€æœ‰å…³é”®æµç¨‹æµ‹è¯•é€šè¿‡
- âœ… API æ–‡æ¡£å®Œæ•´
- âœ… éƒ¨ç½²æ–‡æ¡£æ¸…æ™°

---

### é˜¶æ®µ 8: ç”Ÿäº§å°±ç»ª (Week 19-20)

**ç›®æ ‡**: ä¼˜åŒ–ã€å®‰å…¨åŠ å›ºã€ç”Ÿäº§éƒ¨ç½²

**ä¼˜åŒ–**:

- æ€§èƒ½ä¼˜åŒ–ï¼ˆRedis æŸ¥è¯¢ã€Bundle å¤§å°ï¼‰
- å†…å­˜ä¼˜åŒ–
- æ—¥å¿—çº§åˆ«è°ƒæ•´

**å®‰å…¨**:

- å®‰å…¨å®¡è®¡
- ä¾èµ–æ¼æ´æ‰«æ
- é™æµè°ƒæ•´

**éƒ¨ç½²**:

- Dockeré•œåƒæ„å»º
- CI/CD Pipeline
- ç›‘æ§å‘Šè­¦é…ç½®
- ç°åº¦å‘å¸ƒè®¡åˆ’

**éªŒæ”¶æ ‡å‡†**:

- âœ… æ€§èƒ½æµ‹è¯•è¾¾æ ‡ï¼ˆQPS > v1ï¼‰
- âœ… å®‰å…¨æ‰«æé€šè¿‡
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ
- âœ… ç›‘æ§æ­£å¸¸å·¥ä½œ

---

## æ•°æ®è¿ç§»ç­–ç•¥

### æ–¹æ¡ˆA: åŒå†™æ¨¡å¼ï¼ˆæ¨èï¼‰

```
v1ç»§ç»­è¿è¡Œ â†’ å†™å…¥v1 Redis â†’ åŒæ­¥è„šæœ¬ â†’ å†™å…¥v2 Redis (keyå‰ç¼€v2:)
                â†“
         v2è¯»å–v2 Redis
```

**ä¼˜ç‚¹**:

- v1 å’Œ v2 å®Œå…¨éš”ç¦»
- å¯ä»¥éšæ—¶å›æ»š
- æ•°æ®å®‰å…¨

**ç¼ºç‚¹**:

- éœ€è¦åŒæ­¥è„šæœ¬
- Redis å­˜å‚¨ç©ºé—´ç¿»å€

### æ–¹æ¡ˆB: å…±äº«æ¨¡å¼ï¼ˆé£é™©è¾ƒé«˜ï¼‰

```
v1 å’Œ v2 å…±äº«åŒä¸€ä¸ª Redis
ä½¿ç”¨ä¸åŒçš„keyå‰ç¼€åŒºåˆ†
```

**ä¼˜ç‚¹**:

- æ— éœ€è¿ç§»
- èŠ‚çœå­˜å‚¨

**ç¼ºç‚¹**:

- æ•°æ®ç»“æ„å†²çªé£é™©
- éš¾ä»¥å›æ»š

**æ¨è**: ä½¿ç”¨**æ–¹æ¡ˆA**ï¼Œå®‰å…¨ç¬¬ä¸€

---

## é£é™©æ§åˆ¶

### æŠ€æœ¯é£é™©

| é£é™©                   | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½                         |
| ---------------------- | ---- | ---- | -------------------------------- |
| TypeScript å­¦ä¹ æ›²çº¿    | ä¸­   | ä¸­   | æ¸è¿›å¼è¿ç§»ï¼Œå…ˆè¿ç§»ç®€å•æ¨¡å—       |
| Redis æ•°æ®ä¸ä¸€è‡´       | ä½   | é«˜   | åŒå†™æ¨¡å¼ + æ•°æ®æ ¡éªŒè„šæœ¬          |
| æ€§èƒ½ä¸‹é™               | ä½   | é«˜   | æå‰æ€§èƒ½æµ‹è¯•ï¼ŒQPS åŸºå‡†å¯¹æ¯”       |
| OAuth æµç¨‹é”™è¯¯         | ä¸­   | é«˜   | ä¼˜å…ˆå®ç° + å……åˆ†æµ‹è¯•              |
| å‰ç«¯å…¼å®¹æ€§é—®é¢˜         | ä½   | ä¸­   | ä¿æŒç›¸åŒ UI åº“ï¼ˆTailwindï¼‰       |

### é¡¹ç›®é£é™©

| é£é™©              | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½                       |
| ----------------- | ---- | ---- | ------------------------------ |
| æ—¶é—´è¶…æœŸ          | ä¸­   | ä¸­   | MVP å…ˆè¡Œï¼Œéæ ¸å¿ƒåŠŸèƒ½åç½®       |
| v1 bug éœ€è¦ä¿®å¤   | é«˜   | ä¸­   | ä¿æŒ v1 ç»´æŠ¤ï¼Œv2 å¹¶è¡Œå¼€å‘      |
| éœ€æ±‚å˜æ›´          | ä¸­   | ä¸­   | æ¨¡å—åŒ–è®¾è®¡ï¼Œé™ä½è€¦åˆ           |

---

## æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡

- âœ… QPS >= v1 çš„ 120%
- âœ… P99 å»¶è¿Ÿ < 500ms
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 80%
- âœ… TypeScript ç±»å‹è¦†ç›–ç‡ > 95%
- âœ… Bundle å¤§å° < 500KB (å‰ç«¯)

### åŠŸèƒ½æŒ‡æ ‡

- âœ… 100% åŠŸèƒ½å¯¹ç­‰ï¼ˆä¸ v1ï¼‰
- âœ… API å…¼å®¹æ€§ï¼ˆv1 å®¢æˆ·ç«¯å¯ç›´æ¥åˆ‡æ¢ï¼‰
- âœ… é›¶æ•°æ®ä¸¢å¤±
- âœ… åœæœºæ—¶é—´ < 5 åˆ†é’Ÿï¼ˆåˆ‡æ¢æ—¶ï¼‰

### å¼€å‘ä½“éªŒæŒ‡æ ‡

- âœ… TypeScript ç¼–è¯‘æ—¶é—´ < 10s
- âœ… çƒ­é‡è½½ < 2s
- âœ… æµ‹è¯•è¿è¡Œ < 30s
- âœ… ä»£ç å¯è¯»æ€§æå‡ï¼ˆä¸»è§‚è¯„ä¼°ï¼‰

---

## MVPèŒƒå›´å®šä¹‰

### å¦‚æœæ—¶é—´ç´§å¼ ï¼Œä»¥ä¸‹ä¸ºæœ€å°å¯è¡Œäº§å“

**å¿…é¡»æœ‰**:

1. ç®¡ç†å‘˜ç™»å½• + JWT è®¤è¯
2. API Key ç®¡ç†ï¼ˆCRUD + ä½¿ç”¨ç»Ÿè®¡ï¼‰
3. Claude OAuth è´¦æˆ·ç®¡ç†
4. `/api/v1/messages` è½¬å‘ï¼ˆæµå¼+éæµå¼ï¼‰
5. åŸºç¡€ä»ªè¡¨æ¿

**å¯ä»¥å»¶å**:

- Gemini/OpenAI ç­‰å…¶ä»–å¹³å°
- Webhook é€šçŸ¥
- ç”¨æˆ·ç³»ç»Ÿ
- æ‰¹é‡æ“ä½œ
- é«˜çº§ç»Ÿè®¡

---

## æ€»ç»“ä¸å»ºè®®

### æ ¸å¿ƒåŸåˆ™

1. **åˆ«æå¤§çˆ†ç‚¸å¼é‡å†™** - å¢é‡è¿ç§»ï¼Œå…ˆMVPï¼Œå†æ‰©å±•
2. **åˆ«è¿‡åº¦å·¥ç¨‹åŒ–** - TypeScript å·²ç»å¤Ÿäº†ï¼Œåˆ«åŠ  GraphQLã€å¾®æœåŠ¡
3. **å¤ç”¨æ•°æ®ç»“æ„** - v1 çš„ Redis è®¾è®¡å¾ˆå¥½ï¼Œç›´æ¥ç”¨ TypeScript åŒ…è£…
4. **ä¿æŒç®€å•** - Fastify + Next.js å°±å¤Ÿäº†ï¼Œåˆ«æå¤æ‚æ¶æ„

### æ—¶é—´ä¼°ç®—

**é¢„è®¡æ€»æ—¶é•¿**: 5-6 ä¸ªæœˆï¼ˆå…¨èŒ 1 äººï¼‰æˆ– 3-4 ä¸ªæœˆï¼ˆ2 äººå›¢é˜Ÿï¼‰

**é˜¶æ®µåˆ’åˆ†**:

1. **å‰2ä¸ªæœˆ**: å®Œæˆ MVPï¼ˆé˜¶æ®µ0-2ï¼‰ï¼ŒéªŒè¯æ¶æ„å¯è¡Œæ€§
2. **ç¬¬3-4ä¸ªæœˆ**: å®Œæˆæ ¸å¿ƒè½¬å‘ï¼ˆé˜¶æ®µ3-4ï¼‰ï¼Œç¡®ä¿åŠŸèƒ½å¯¹ç­‰
3. **ç¬¬5-6ä¸ªæœˆ**: è¡¥å……å®Œæ•´åŠŸèƒ½ï¼ˆé˜¶æ®µ5-8ï¼‰ï¼Œä¼˜åŒ–å’Œæµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-04
**ç»´æŠ¤è€…**: Claude Code Team
